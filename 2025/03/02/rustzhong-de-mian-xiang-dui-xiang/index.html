<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Rust中的面向对象编程特性, 立身于大雪弥漫、浓雾障眼的山口，只能偶尔瞥见未必正确的路径，只需睁大双眼，昂起头颅，走好脚下的路，不管它通向何方。">
    <meta name="description" content="本章探讨了Rust如何实现面向对象编程（OOP）的特性，尽管Rust并非传统OOP语言。它介绍了OOP的核心概念（如封装、多态、继承），并展示了Rust通过结构体、枚举、trait和模式实现类似功能。本章包括定义OOP特征、使用trait对">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="white"/>
    <title>Rust中的面向对象编程特性 | Sparks Fly</title>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <style type="text/css">
        
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }

        
    </style>
    <script src="/libs/jquery/jquery.min.js"></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Sparks Fly" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                        <img src="/apple-touch-icon.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Sparks Fly</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/" class="waves-effect waves-light">
                    
                        <i class="fa fa-home"></i>
                    
                    <span>首页</span>
                </a>

            
        </li>
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/categories" class="waves-effect waves-light">
                    
                        <i class="fa fa-bookmark"></i>
                    
                    <span>分类</span>
                </a>

            
        </li>
    
        <li class="hide-on-med-and-down nav-item">

            
                <a href="/archives" class="waves-effect waves-light">
                    
                        <i class="fa fa-archive"></i>
                    
                    <span>归档</span>
                </a>

            
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
            <img src="/medias/avatars/avatar.png"
                 class="logo-img circle responsive-img">
        
        <div class="logo-name">Sparks Fly</div>
        <div class="logo-desc">
            
                Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
            <li class="m-nav-item">
                
                    <a href="/" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-home"></i>
                        
                        首页
                    </a>
                
            </li>
        
            <li class="m-nav-item">
                
                    <a href="/categories" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-bookmark"></i>
                        
                        分类
                    </a>
                
            </li>
        
            <li class="m-nav-item">
                
                    <a href="/archives" class="waves-effect waves-light">
                        
                            <i class="fa fa-fw fa-archive"></i>
                        
                        归档
                    </a>
                
            </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Rust中的面向对象编程特性</h1>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
        <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">Awsome</span>
                        </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                                <a href="/categories/Rust/" class="post-category">
                                    Rust
                                </a>
                            
                        </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2025-03-02
                    </div>
                

                
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-check-o fa-fw"></i>更新日期:&nbsp;&nbsp;
                        2025-03-02
                    </div>
                

                
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        5.8k
                    </div>
                

                
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        23 分
                    </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>本章探讨了Rust如何实现面向对象编程（OOP）的特性，尽管Rust并非传统OOP语言。它介绍了OOP的核心概念（如封装、多态、继承），并展示了Rust通过结构体、枚举、trait和模式实现类似功能。本章包括定义OOP特征、使用trait对象实现多态，以及状态模式示例。</p>
<h2 id="1-面向对象语言的特征"><a href="#1-面向对象语言的特征" class="headerlink" title="1 .面向对象语言的特征"></a>1 .面向对象语言的特征</h2><p>由 Erich Gamma、Richard Helm、Ralph Johnson 和 John Vlissides（Addison-Wesley Professional, 1994）编写的书 <em>Design Patterns: Elements of Reusable Object-Oriented Software</em> 被俗称为 <em>The Gang of Four</em> (字面意思为“四人帮”)，它是面向对象编程模式的目录。它这样定义面向对象编程：</p>
<blockquote>
<p>Object-oriented programs are made up of objects. An <em>object</em> packages both data and the procedures that operate on that data. The procedures are typically called <em>methods</em> or <em>operations</em>.</p>
<p>面向对象的程序是由对象组成的。一个 <strong>对象</strong> 包含数据和操作这些数据的过程。这些过程通常被称为 <strong>方法</strong> 或 <strong>操作</strong>。</p>
</blockquote>
<h3 id="1-Rust对象包含数据"><a href="#1-Rust对象包含数据" class="headerlink" title="1.Rust对象包含数据"></a>1.Rust对象包含数据</h3><p>在上面的定义中，Rust 是面向对象的：结构体和枚举包含数据而 <code>impl</code> 块提供了在结构体和枚举之上的方法。</p>
<p>虽然带有方法的结构体和枚举并不被称为对象，但是他们提供了与对象相同的功能，参考 <em>The Gang of Four</em> 中对象的定义。</p>
<h3 id="2-Rust中的封装"><a href="#2-Rust中的封装" class="headerlink" title="2.Rust中的封装"></a>2.Rust中的封装</h3><p><strong>封装（encapsulation）</strong>的思想：对象的实现细节不能被使用对象的代码获取到。所以唯一与对象交互的方式是通过对象提供的公有 API，使对象的调用者无法深入到对象内部并直接改变数据或者行为。</p>
<p>封装使得改变和重构对象的内部时无需改变使用对象的代码，下面的代码展示了Rust中的封装：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> AverageCollection <span class="token punctuation">{</span>
    list<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">></span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 私有：存储整数列表</span>
    average<span class="token punctuation">:</span> f64<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 私有：存储平均值</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> AverageCollection <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 构造方法，初始化空集合</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        AverageCollection <span class="token punctuation">{</span>
            list<span class="token punctuation">:</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            average<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 添加值并更新平均值</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 每次添加后自动更新</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 移除值并更新平均值</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span>i32<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> result <span class="token punctuation">{</span>
            <span class="token function">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 移除后更新</span>
                <span class="token function">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            None <span class="token operator">=</span><span class="token operator">></span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 获取平均值，只读访问</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">average</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> f64 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>average
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 私有方法：更新平均值，处理空列表</span>
    <span class="token keyword">fn</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>average <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 空列表时平均值为 0</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> total<span class="token punctuation">:</span> i32 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>average <span class="token operator">=</span> total <span class="token keyword">as</span> f64 <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f64<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> collection <span class="token operator">=</span> AverageCollection<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Average: {}"</span><span class="token punctuation">,</span> collection<span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 7.5</span>
    collection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Average: {}"</span><span class="token punctuation">,</span> collection<span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 5.0</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>封装在代码中的具体体现</strong></p>
<ol>
<li><strong>字段私有性：</strong><ul>
<li><code>list: Vec&lt;i32&gt;</code>和 <code>average: f64</code> 没有标记<code>pub</code>，默认私有。</li>
<li>外部代码无法直接访问 collection.list 或 collection.average，只能通过方法操作。</li>
<li><strong>体现</strong>：隐藏了实现细节，外部不知道数据如何存储。</li>
</ul>
</li>
<li><strong>公开方法控制访问</strong>：<ul>
<li><code>pub fn add</code>：允许外部添加值，但只能通过push间接修改list，无法直接操作列表。</li>
<li>`pub fn remove：允许移除值并更新平均值，封装了逻辑（移除后自动更新）。</li>
<li><code>pub fn average</code>：提供只读访问，返回average，不暴露修改途径。</li>
<li>体现：通过接口暴露功能，保护内部状态。</li>
</ul>
</li>
<li><strong>私有方法隐藏实现：</strong><ul>
<li><code>fn update</code> 没有<code>pub</code>，是私有的，仅在结构体内部调用。</li>
<li>外部无法直接调用update，只能通过remove触发。</li>
<li>体现：计算平均值的逻辑被隐藏，外部无需关心。</li>
</ul>
</li>
<li><strong>可变性控制：</strong><ul>
<li><code>add</code> 和 <code>remove</code> 使用<code>&amp;mut self</code>，要求可变引用，限制了无意修改。</li>
<li><code>average</code>使用<code>&amp;self</code>，只读访问，确保数据一致性。</li>
<li>体现：Rust借用规则增强封装，防止意外更改。</li>
</ul>
</li>
</ol>
<p>如果封装是一个语言被认为是面向对象语言所必要的方面的话，那么 Rust 满足这个要求。在代码中不同的部分使用 <code>pub</code> 与否可以封装其实现细节。</p>
<p><strong>Rust与OOP：</strong></p>
<ul>
<li><p><strong>对象</strong>：Rust通过结构体和枚举定义数据及其行为。</p>
</li>
<li><p><strong>封装</strong>：Rust使用pub关键字控制访问权限，支持隐藏实现细节。</p>
</li>
<li><p><strong>多态</strong>：Rust通过泛型和trait实现代码复用和类型灵活性。</p>
</li>
<li><p><strong>继承</strong>：Rust无传统继承，使用trait组合代替。</p>
</li>
<li><p><strong>权衡</strong>：Rust强调内存安全和性能，牺牲了一些OOP便利性。</p>
</li>
</ul>
<h3 id="3-Rust中的继承实现"><a href="#3-Rust中的继承实现" class="headerlink" title="3.Rust中的继承实现"></a>3.Rust中的继承实现</h3><p><strong>继承（Inheritance）</strong>是一个很多编程语言都提供的机制，一个对象可以定义为继承另一个对象的定义，这使其可以获得父对象的数据和行为，而无需重新定义。</p>
<p>如果一个语言必须有继承才能被称为面向对象语言的话，那么 Rust 就不是面向对象的。无法定义一个结构体继承父结构体的成员和方法。然而，如果你过去常常在你的编程工具箱使用继承，根据你最初考虑继承的原因，Rust 也提供了其他的解决方案。</p>
<p>选择继承有两个主要的原因</p>
<ul>
<li><p>第一个是为了重用代码：一旦为一个类型实现了特定行为，继承可以对一个不同的类型重用这个实现。相反 Rust 代码可以使用默认 trait 方法实现来进行共享</p>
<pre class="line-numbers language-rust"><code class="language-rust">
<span class="token comment" spellcheck="true">// 定义一个 trait</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> Summary <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">summarize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String<span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Default Summary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> NewArticle <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> title<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> headline<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> author<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Summary <span class="token keyword">for</span> NewArticle <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">summarize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//类似于继承的实现</span>
        <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"{}, {}, ({})"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>headline<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> article <span class="token operator">=</span> NewArticle <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Rust Traits"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        headline<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Understanding Rust"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        content<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Rust provides powerful trait functionality."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span><span class="token function">summarize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Rust Traits, Understanding Rust, (Rust provides powerful trait functionality.)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在示例中我们在 <code>Summary</code> trait 有一个 <code>summarize</code> 方法的默认实现。任何实现了 <code>Summary</code> trait 的类型都可以使用 <code>summarize</code> 方法而无须进一步实现。这类似于父类有一个方法的实现，而通过继承子类也拥有这个方法的实现。当实现 <code>Summary</code> trait 时也可以选择覆盖 <code>summarize</code> 的默认实现，这类似于子类覆盖从父类继承的方法实现。</p>
</li>
<li><p>第二个使用继承的原因与类型系统有关：表现为子类型可以用于父类型被使用的地方。这也被称为 <strong>多态</strong>（<em>polymorphism</em>），这意味着如果多种对象共享特定的属性，则可以相互替代使用。</p>
<blockquote>
<p>多态（Polymorphism）</p>
<p>很多人将多态描述为继承的同义词。不过它是一个有关可以用于多种类型的代码的更广泛的概念。对于继承来说，这些类型通常是子类。 Rust 则通过泛型来对不同的可能类型进行抽象，并通过 trait bounds 对这些类型所必须提供的内容施加约束。这有时被称为 <em>bounded parametric polymorphism</em>。</p>
</blockquote>
<p>近来继承作为一种语言设计的解决方案在很多语言中失宠了，因为其时常带有共享多于所需的代码的风险。子类不应总是共享其父类的所有特征，但是继承却始终如此。如此会使程序设计更为不灵活，并引入无意义的子类方法调用，或由于方法实际并不适用于子类而造成错误的可能性。某些语言还只允许子类继承一个父类，进一步限制了程序设计的灵活性。</p>
<p>因为这些原因，Rust 选择了一个不同的途径，使用 trait 对象而不是继承。让我们看一下 Rust 中的 trait 对象是如何实现多态的。17.2 为博客文章实现一个状态模式</p>
</li>
</ul>
<h2 id="2-使用trait对象以实现运行时多态"><a href="#2-使用trait对象以实现运行时多态" class="headerlink" title="2.使用trait对象以实现运行时多态"></a>2.使用trait对象以实现运行时多态</h2><p>Rust中的trait对象（trait objects）是一种实现运行时多态的方式，允许在同一集合中存储实现某个trait的不同类型。</p>
<h3 id="1-Trait-对象的定义与用途"><a href="#1-Trait-对象的定义与用途" class="headerlink" title="1. Trait 对象的定义与用途"></a>1. Trait 对象的定义与用途</h3><p><strong>定义：</strong></p>
<ul>
<li>trait 对象通过 <code>dyn Trait</code> 关键字表示，允许<code>动态分发（dynamic dispatch）</code>，在运行时调用具体类型的实现。</li>
<li>使用 <code>Box&lt;dyn Trait&gt;</code>（堆分配）或 <code>&amp;dyn Trait</code>（引用）存储。</li>
</ul>
<p><strong>用途：</strong></p>
<ul>
<li><strong>实现多态</strong>：将实现同一 trait 的不同类型统一处理。</li>
<li><strong>解决类型异构问题</strong>：允许集合（如 <code>Vec</code>）存储多种类型。</li>
</ul>
<p><strong>与 OOP 的关系：</strong></p>
<ul>
<li>类似 OOP 中的接口或抽象基类，但 Rust 无继承，依赖 trait。</li>
</ul>
<h3 id="2-使用trait对象实现多态"><a href="#2-使用trait对象实现多态" class="headerlink" title="2. 使用trait对象实现多态"></a>2. 使用trait对象实现多态</h3><ul>
<li><strong>场景</strong>：需要处理一组行为相同但类型不同的对象。</li>
</ul>
<p>实现一个简单的GUI（Graphical User Interface， GUI）组件系统，Screen管理并绘制一组组件（Button 和 SelcetedBox），通过 Draw trait 实现多态：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// trait 是 Rust 中定义行为的抽象方式，类似于接口</span>
<span class="token keyword">trait</span> Draw <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 具体类型需提供绘制行为的实现</span>
    <span class="token keyword">fn</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 定义 Screen 结构体，用于管理一组可绘制组件</span>
<span class="token keyword">struct</span> Screen <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// components 字段存储实现了 Draw trait 的 trait 对象集合</span>
    <span class="token comment" spellcheck="true">// 使用 Vec&lt;Box&lt;dyn Draw>> 因为 trait 对象大小未知，需通过 Box 堆分配</span>
    components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn Draw<span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Screen <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn Draw<span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Screen <span class="token punctuation">{</span>
        Screen <span class="token punctuation">{</span>
            components<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 将传入的组件向量赋值给字段</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 遍历并绘制所有组件</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>components<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 动态调用每个组件的 draw 方法</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 定义 Button 结构体，表示按钮组件</span>
<span class="token keyword">struct</span> Button <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 按钮宽度</span>
    length<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 按钮长度</span>
    label<span class="token punctuation">:</span> String<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 按钮标签</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Button <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> length<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> label<span class="token punctuation">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">-></span> Button <span class="token punctuation">{</span>
        Button <span class="token punctuation">{</span>
            width<span class="token punctuation">,</span>
            length<span class="token punctuation">,</span>
            label<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 为 Button 实现 Draw trait</span>
<span class="token keyword">impl</span> Draw <span class="token keyword">for</span> Button <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 实现 draw 方法，定义按钮的绘制行为</span>
    <span class="token keyword">fn</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Drawing a button: {} ({}x{})"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>label<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> SelectedBox <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 选择框宽度</span>
    length<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 选择框长度</span>
    options<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 选择框的可选项列表</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> SelectedBox <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> length<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> options<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SelectedBox <span class="token punctuation">{</span>
        SelcetedBox <span class="token punctuation">{</span>
            width<span class="token punctuation">,</span>
            length<span class="token punctuation">,</span>
            options<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 为 SelcetedBox 实现 Draw trait</span>
<span class="token keyword">impl</span> Draw <span class="token keyword">for</span> SelectedBox <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 实现 draw 方法，定义选择框的绘制行为</span>
    <span class="token keyword">fn</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Drawing a box: {} ({}x{})"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 主函数，程序入口</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建 components 向量，显式指定类型为 Vec&lt;Box&lt;dyn Draw>> 使用 Box 将具体类型装箱为 trait 对象，支持多态</span>
    <span class="token keyword">let</span> components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn Draw<span class="token operator">>></span> <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span>
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Button<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 创建并装箱 Button</span>
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>SelcetedBox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token function">vec!</span><span class="token punctuation">[</span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 创建并装箱 SelcetedBox</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> screen <span class="token operator">=</span> Screen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>components<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 调用 run 方法，绘制所有组件</span>
    screen<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出：</strong></p>
<pre class="line-numbers language-shell"><code class="language-shell">Drawing a button: OK (75x10)
Drawing a select box (100x20) with 2 options<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>Screen</code> 的 <code>components</code> 使用 <code>Vec&lt;Box&lt;dyn Draw&gt;&gt;</code>，统一存储 <code>Button</code> 和 <code>SelectBox</code>。</li>
<li><code>Box::new</code> 将具体类型装箱为 <code>dyn Draw</code>，实现类型异构。</li>
<li><code>run</code> 方法通过动态分发调用每个组件的 <code>draw</code>。</li>
</ul>
<h3 id="3-trait-对象执行动态分发"><a href="#3-trait-对象执行动态分发" class="headerlink" title="3. trait 对象执行动态分发"></a>3. trait 对象执行动态分发</h3><ul>
<li><p><strong>动态分发（Dynamic Dispatch）</strong>： 上面的GUI程序就是一个简单的动态分发示例</p>
<ul>
<li><strong>定义</strong>：编译器在编译时无法确定调用哪个具体方法，需在运行时通过指针（如虚表）决定。</li>
<li><strong>适用场景</strong>：使用trait对象（dyn Trait）时，Rust必须采用动态分发。</li>
<li><strong>机制</strong>：trait对象包含数据指针和虚表指针，运行时查找方法实现。</li>
<li><strong>缺点</strong>：运行时开销（虚表查找），无法内联，禁用部分优化。</li>
<li><strong>优点</strong>：支持类型异构，灵活性高。</li>
</ul>
</li>
</ul>
<p>  <strong>与静态分发的对比</strong>：</p>
<ul>
<li><p><strong>静态分发（Static Dispatch））</strong>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// 使用泛型定义 Screen，只能处理单一类型</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Screen<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Draw<span class="token operator">></span> <span class="token punctuation">{</span>
    components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 限制为同一类型 T</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Draw<span class="token operator">></span> Screen<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建 Screen，接受单一类型的组件</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Screen<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        Screen <span class="token punctuation">{</span> components <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 静态调用 draw 方法</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> component <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>components<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            component<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 编译时确定调用</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 只能存储 Button，无法混用 SelectBox</span>
    <span class="token keyword">let</span> screen <span class="token operator">=</span> Screen <span class="token punctuation">{</span>
        components<span class="token punctuation">:</span> <span class="token function">vec!</span><span class="token punctuation">[</span>
            Button <span class="token punctuation">{</span>
                width<span class="token punctuation">:</span> <span class="token number">75</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            Button <span class="token punctuation">{</span>
                width<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Cancel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    screen<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<ul>
<li><strong>定义</strong>：编译器在编译时通过单态化（monomorphization）生成具体类型的代码，知道调用哪个方法。</li>
<li><strong>适用场景</strong>：<ul>
<li>需要高性能，无需存储多个不同类型的对象。</li>
<li>适用于算法实现，如 <code>Iterator</code> 相关操作。</li>
<li>代码生成少量不同类型的实例，不会导致过多的二进制代码膨胀。</li>
</ul>
</li>
<li><strong>优点</strong>：无运行时开销，可内联优化。</li>
<li><strong>缺点</strong>：只能处理单一类型，缺乏灵活性。</li>
</ul>
<h3 id="4-trait对象的要求与限制"><a href="#4-trait对象的要求与限制" class="headerlink" title="4. trait对象的要求与限制"></a>4. trait对象的要求与限制</h3><p><strong>对象安全（Object Safety）</strong>：</p>
<ul>
<li><p><strong>定义</strong>：只有对象安全的trait才能作为trait对象（dyn Trait）。</p>
</li>
<li><p><strong>必要性</strong>：<code>trait对象</code>运行时忘记具体类型，需确保方法调用不依赖类型细节。</p>
</li>
<li><p><strong>对象安全规则</strong>：</p>
<ol>
<li><strong>返回值不为 Self</strong>：<code>Self</code>是实现trait的具体类型，trait对象无法知道具体类型。</li>
<li><strong>方法无泛型参数</strong>：泛型参数在编译时替换为具体类型，trait对象无法处理。</li>
</ol>
</li>
<li><p><strong>非对象安全的例子</strong>：<code>Clone</code>trait 的 <code>clone</code> 方法返回 <code>Self</code>，不满足对象安全。</p>
</li>
<li><p><strong>对象安全的例子</strong>：<code>Draw</code> trait 的 <code>draw</code>方法无 <code>Self</code> 返回值、无泛型，满足要求。</p>
</li>
</ul>
<p>示例（非对象安全的 trait）：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> Clone <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回 Self，不满足对象安全</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>Clone</code> trait 的 <code>clone</code> 方法返回 <code>Self</code>，无法作为 <code>dyn Clone</code>，因为运行时无法确定具体类型。</p>
<p>反例（对象安全的 trait）：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> Draw <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 无 Self 或泛型，对象安全</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="3-使用trait对象实现面向对象设计模式"><a href="#3-使用trait对象实现面向对象设计模式" class="headerlink" title="3.使用trait对象实现面向对象设计模式"></a>3.使用trait对象实现面向对象设计模式</h2><p><strong>状态模式</strong>（<em>state pattern</em>）是一个面向对象设计模式。</p>
<p>该模式的关键在于一个值有某些内部状态，体现为一系列的 <strong>状态对象</strong>，同时值的行为随着其内部状态而改变。每一个状态对象负责其自身的行为，以及该状态何时应当转移至另一个状态。持有一个状态对象的值对于不同状态的行为以及何时状态转移毫不知情。</p>
<p>为了探索这个概念，我们将实现一个增量式的发布博文的工作流。这个博客的最终功能看起来像这样：</p>
<ol>
<li>博文从空白的草案开始。</li>
<li>一旦草案完成，请求审核博文。</li>
<li>一旦博文过审，它将被发表。</li>
<li>只有被发表的博文的内容会被打印，这样就不会意外打印出没有被审核的博文的文本。</li>
</ol>
<h3 id="1-状态模式的定义与-Rust-实现"><a href="#1-状态模式的定义与-Rust-实现" class="headerlink" title="1. 状态模式的定义与 Rust 实现"></a>1. 状态模式的定义与 Rust 实现</h3><p><strong>定义：</strong></p>
<ul>
<li>状态模式允许对象在内部状态变化时改变行为，外部看起来像改变了类型。</li>
<li>核心思想：将状态相关行为封装在独立对象中，通过状态切换改变行为。</li>
</ul>
<p><strong>Rust 实现：</strong></p>
<ul>
<li>使用 trait 对象（<code>Box&lt;dyn State&gt;</code>）定义状态接口和行为。</li>
<li>状态转换通过方法调用实现，结构体管理状态切换。</li>
</ul>
<h3 id="2-使用-trait-对象实现状态模式"><a href="#2-使用-trait-对象实现状态模式" class="headerlink" title="2. 使用 trait 对象实现状态模式"></a>2. 使用 trait 对象实现状态模式</h3><p><strong>场景：</strong></p>
<ul>
<li>示例：实现一个博客文章状态管理系统，支持状态切换（草稿 -&gt; 待审 -&gt; 已发布），并根据状态控制文本添加和内容可见性</li>
</ul>
<p><strong>实现方式：</strong></p>
<ul>
<li>定义 <code>State</code> trait，包含状态转换方法和内容访问方法。</li>
<li>每个状态（<code>Draft</code>、<code>PendingReview</code>、<code>Published</code>）作为结构体实现 trait。</li>
<li><code>Post</code> 结构体通过 <code>Box&lt;dyn State&gt;</code> 持有当前状态。</li>
</ul>
<p><strong>代码示例（完整状态模式）：</strong></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// 定义 State trait，描述博客文章的状态行为</span>
<span class="token keyword">trait</span> State <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// 添加文本，只需 content 的可变引用，避免借用整个 Post</span>
    <span class="token keyword">fn</span> <span class="token function">add_txt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> String<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 请求审核，切换状态，返回新的 trait 对象</span>
    <span class="token comment" spellcheck="true">// 使用 Box&lt;Self> 表示当前状态的所有权被转移，Box&lt;dyn State> 是动态分发的返回值</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 批准发布，切换状态，返回新的 trait 对象</span>
    <span class="token comment" spellcheck="true">// Box&lt;Self> 表示状态实例被消耗，需返回新的状态</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 返回内容，默认实现返回空字符串，表示不可见</span>
    <span class="token comment" spellcheck="true">// 'a 生命周期确保返回的引用与 Post 的生命周期一致</span>
    <span class="token keyword">fn</span> content<span class="token operator">&lt;</span><span class="token string">'a>(&amp;self, _post: &amp;'</span>a Post<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'a str <span class="token punctuation">{</span>
        <span class="token string">""</span> <span class="token comment" spellcheck="true">// 默认不可见</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 定义 Post 结构体，管理文章内容和状态</span>
<span class="token keyword">struct</span> Post <span class="token punctuation">{</span>
    state<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn State<span class="token operator">>></span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 使用 Option 和 Box&lt;dyn State> 持有当前状态，便于切换</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">// 文章内容，存储为字符串</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Post <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建新文章，初始状态为草稿</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Post <span class="token punctuation">{</span>
        Post <span class="token punctuation">{</span>
            state<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Draft <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 初始化为 Draft 状态，装箱为 trait 对象</span>
            content<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// content 初始化为空字符串</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 添加文本，直接修改 content</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_txt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _content<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 使用不可变引用获取状态</span>
            state<span class="token punctuation">.</span><span class="token function">add_txt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span> _content<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 调用状态的 add_txt 方法</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 请求审核，切换状态</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// take() 取出当前状态，留下 None</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">request_review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 调用状态的 request_review，替换为新状态</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 批准发布，切换状态</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 取出当前状态</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用状态的 approve，替换为新状态</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 返回内容，由当前状态决定是否可见</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// as_ref() 获取状态引用，unwrap() 解包，动态调用 content</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 草稿状态</span>
<span class="token keyword">struct</span> Draft <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> State <span class="token keyword">for</span> Draft <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// 添加文本，只需 content 的可变引用，避免借用整个 Post</span>
    <span class="token keyword">fn</span> <span class="token function">add_txt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> String<span class="token punctuation">,</span> _content<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">{</span>
        content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>_content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 草稿状态请求审核，转为待审状态</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>PendingReview <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 创建并返回新的 PendingReview 状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 草稿状态下批准无效，返回自身</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token comment" spellcheck="true">// 原样返回，不改变状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 草稿状态下内容不可见，使用默认实现（返回 ""）</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 待审状态</span>
<span class="token keyword">struct</span> PendingReview <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> State <span class="token keyword">for</span> PendingReview <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 待审状态下再次请求审核，无变化</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token comment" spellcheck="true">// 返回自身，不改变状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 待审状态下批准，转为已发布状态</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Published <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 创建并返回新的 Published 状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 待审状态下内容不可见，使用默认实现（返回 ""）</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 已发布状态</span>
<span class="token keyword">struct</span> Published <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> State <span class="token keyword">for</span> Published <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 已发布状态下请求审核，无变化</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token comment" spellcheck="true">// 返回自身，不改变状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 已发布状态下再次批准，无变化</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token comment" spellcheck="true">// 返回自身，不改变状态</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 已发布状态下返回文章内容</span>
    <span class="token keyword">fn</span> content<span class="token operator">&lt;</span><span class="token string">'a>(&amp;self, _post: &amp;'</span>a Post<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'a str <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span>_post<span class="token punctuation">.</span>content <span class="token comment" spellcheck="true">// 返回 Post 的 content 的引用</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 主函数，测试状态转换流程</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> post <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 创建新文章，初始为草稿状态</span>
    post<span class="token punctuation">.</span><span class="token function">add_txt</span><span class="token punctuation">(</span><span class="token string">"I ate salad for lunch today"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 添加文本</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 草稿状态，内容不可见，返回空字符串</span>

    post<span class="token punctuation">.</span><span class="token function">request_review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 请求审核，转为待审状态</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 待审状态，内容不可见</span>

    post<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">// 批准，转为已发布状态</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">"I ate salad for lunch today"</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 已发布状态，内容可见</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>设计与特点</strong></p>
<ol>
<li><strong>状态模式</strong>：<ul>
<li>行为（添加、审核、批准、内容访问）封装在状态对象中。</li>
<li>Post 通过状态切换改变行为，符合状态模式思想。</li>
</ul>
</li>
<li><strong>Rust特性</strong>：<ul>
<li>trait对象：<code>Box&lt;dyn State&gt;</code> 实现动态分发，模拟多态。</li>
<li>所有权：<code>Option</code>和<code>take()</code> 管理状态转移，避免借用冲突。</li>
<li>借用：<code>add_txt</code> 只借用 <code>content</code>，确保安全。</li>
</ul>
</li>
<li><strong>权衡</strong>：<ul>
<li>优点：扩展性强，新增状态只需实现新类型。</li>
<li>缺点：动态分发有性能开销，Box 增加堆分配。</li>
</ul>
</li>
</ol>
<h3 id="3-状态模式的优点"><a href="#3-状态模式的优点" class="headerlink" title="3. 状态模式的优点"></a>3. 状态模式的优点</h3><ul>
<li><strong>封装性</strong>：状态行为封装在独立类型中，<code>Post</code> 无需条件判断。</li>
<li><strong>扩展性</strong>：添加新状态（如“待编辑”）只需实现新结构体和 trait，无需修改 <code>Post</code>。</li>
<li><strong>类型安全</strong>：Rust 编译器确保状态方法调用正确。</li>
</ul>
<h3 id="4-状态模式的缺点与权衡"><a href="#4-状态模式的缺点与权衡" class="headerlink" title="4. 状态模式的缺点与权衡"></a>4. 状态模式的缺点与权衡</h3><ul>
<li><strong>复杂性</strong>：使用 trait 对象和 <code>Box</code> 增加代码复杂度，状态转换需手动管理。</li>
<li><strong>性能开销</strong>：动态分发（<code>dyn State</code>）比静态分发慢，涉及虚表查找和堆分配。</li>
<li><strong>Rust 限制</strong>：无继承，状态模式依赖 trait 模拟，代码量较多。</li>
</ul>
<h3 id="5-使用枚举替代状态模式"><a href="#5-使用枚举替代状态模式" class="headerlink" title="5. 使用枚举替代状态模式"></a>5. 使用枚举替代状态模式</h3><p><strong>替代方案：</strong></p>
<ul>
<li>用枚举定义状态，结合 <code>match</code> 实现行为。</li>
<li><strong>优点</strong>：静态分发，无运行时开销，代码更简洁。</li>
<li><strong>缺点</strong>：添加新状态需修改枚举和 <code>match</code>，扩展性较差。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// 定义 Post 结构体，用于管理文章内容和状态</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Post <span class="token punctuation">{</span>
    state<span class="token punctuation">:</span> State<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 使用枚举 State 表示文章状态，替代 trait 对象</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 文章内容，存储为字符串</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 定义 State 枚举，表示文章的三种可能状态</span>
<span class="token keyword">enum</span> State <span class="token punctuation">{</span>
    Draft<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 草稿状态：可编辑，内容不可见</span>
    PendingReview<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 待审状态：不可编辑，内容不可见</span>
    Published<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 已发布状态：不可编辑，内容可见</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 为 Post 实现方法</span>
<span class="token keyword">impl</span> Post <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建新文章，初始为草稿状态</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Post <span class="token punctuation">{</span>
        Post <span class="token punctuation">{</span>
            state<span class="token punctuation">:</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>Draft<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 设置初始状态为 Draft</span>
            content<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 初始化 content 为空字符串</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 添加文本，仅在草稿状态有效</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用 matches! 检查当前状态是否为 Draft</span>
        <span class="token keyword">if</span> <span class="token function">matches!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>Draft<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果是 Draft，追加文本到 content</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其他状态（PendingReview, Published）忽略添加操作</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 请求审核，将草稿状态切换到待审状态</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用 matches! 检查当前状态是否为 Draft</span>
        <span class="token keyword">if</span> <span class="token function">matches!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>Draft<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>PendingReview<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果是 Draft，切换到 PendingReview</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其他状态（PendingReview, Published）不改变</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 批准发布，将待审状态切换到已发布状态</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用 matches! 检查当前状态是否为 PendingReview</span>
        <span class="token keyword">if</span> <span class="token function">matches!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>PendingReview<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">:</span><span class="token punctuation">:</span>Published<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果是 PendingReview，切换到 Published</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其他状态（Draft, Published）不改变</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 返回内容，根据当前状态决定是否可见</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 使用 match 匹配当前状态</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token punctuation">{</span>
            State<span class="token punctuation">:</span><span class="token punctuation">:</span>Published <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Published 状态返回 content 的引用</span>
            _ <span class="token operator">=</span><span class="token operator">></span> <span class="token string">""</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">// Draft 或 PendingReview 返回空字符串</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 主函数，测试状态转换流程</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建新文章，初始为草稿状态</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> post <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 添加文本，测试草稿状态的可编辑性</span>
    post<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">"I ate salad for lunch today"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 草稿状态，内容不可见，预期返回 ""</span>

    <span class="token comment" spellcheck="true">// 请求审核，切换到待审状态</span>
    post<span class="token punctuation">.</span><span class="token function">request_review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 待审状态，内容不可见，预期返回 ""</span>

    <span class="token comment" spellcheck="true">// 批准发布，切换到已发布状态</span>
    post<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">"I ate salad for lunch today"</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 已发布状态，内容可见</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                           
                        </div>
                    
                </div>
                <div class="post_share"
                     style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
            <div class="article col s12 m6" data-aos="fade-up">
                <div class="article-badge left-badge text-color">
                    <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
                <div class="card">
                    <a href="/2025/03/03/rustzhong-de-mo-shi-yu-mo-shi-pi-pei/">
                        <div class="card-image">
                            
                                
                                <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Rust中的模式与模式匹配">
                            
                            <span class="card-title">Rust中的模式与模式匹配</span>
                        </div>
                    </a>
                    <div class="card-content article-content">
                        <div class="summary block-with-text">
                            
                                模式（Patterns）是 Rust 中特殊的语法，它用来匹配类型中的结构，无论类型是简单还是复杂。结合使用模式和 match 表达式以及其他结构可以提供更多对程序控制流的支配权。模式由如下一些内容组合而成：

字面值
解构的数组、枚举、结
                            
                        </div>
                        <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2025-03-03
                        </span>
                            <span class="publish-author">
                                
                                    <i class="fa fa-bookmark fa-fw icon-category"></i>
                                    
                                        <a href="/categories/Rust/" class="post-category">
                                    Rust
                                </a>
                                    
                                
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
        
        
            <div class="article col s12 m6" data-aos="fade-up">
                <div class="article-badge right-badge text-color">
                    下一篇&nbsp;<i class="fa fa-chevron-right"></i>
                </div>
                <div class="card">
                    <a href="/2025/03/02/rustzhong-de-bing-fa-bian-cheng/">
                        <div class="card-image">
                            
                                
                                <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="Rust中的并发编程">
                            
                            <span class="card-title">Rust中的并发编程</span>
                        </div>
                    </a>
                    <div class="card-content article-content">
                        <div class="summary block-with-text">
                            
                                1 .线程（Threads）在大部分现代操作系统中，已执行程序的代码在一个 进程（process）中运行，操作系统则负责管理多个进程。在程序内部，也可以拥有多个同时运行的独立部分。运行这些独立部分的功能被称为 线程（threads）。
将程
                            
                        </div>
                        <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2025-03-02
                            </span>
                            <span class="publish-author">
                                
                                    <i class="fa fa-bookmark fa-fw icon-category"></i>
                                    
                                        <a href="/categories/Rust/" class="post-category">
                                    Rust
                                </a>
                                    
                                
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
        
    </div>
</article>
</div>




<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

    <script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

    <script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->


<!-- 代码块折行 -->

    <style type="text/css">
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }
    </style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

    <div id="floating-toc-btn" class="hide-on-med-and-down">
        <a class="btn-floating btn-large bg-color">
            <i class="fa fa-list"></i>
        </a>
    </div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换 TOC 目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2022</span>
            <a href="/about" rel="external nofollow noreferrer">xinyichen</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> 
            <br>
			 <span id="sitetime">载入运行时间...</span>
            
            
            
            
            <br>
            
			
			 
				&nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
						class="white-color">449k</span>&nbsp;字
             
            

                
                <script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "5";
                        var startDate = "26";
                        var startHour = "21";
                        var startMinute = "10";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            document.getElementById("year").innerHTML = todayYear;
                            document.getElementById("sitetime").innerHTML = "本站已运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }

                    setInterval(siteTime, 1000);
                </script>
            

        </div>
        <!-- <div class="col s12 m4 l4 social-link ">

















</div> -->
    </div>
</footer>

<div class="progress-bar"></div>



<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<!-- 异步加载 search.js -->
<script src="/js/search.js"></script>

<!-- 延迟加载 search.xml -->
<script type="text/javascript">
    $(function () {
        // 延迟500毫秒加载搜索数据，避免阻塞页面加载
        setTimeout(function () {
            searchFunc("/search.xml", 'searchInput', 'searchResult');
        }, 500);
    });
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->


<!-- Baidu Analytics -->


<!-- Baidu Push -->


    <script src="/libs/others/clicklove.js" async="async"></script>




<script type="text/javascript">
    var OriginTitile = document.title,
        st;
    document.addEventListener("visibilitychange", function () {
        document.hidden ? (document.title = "(oﾟvﾟ)ノ Hi", clearTimeout(st)) : (document.title =
            "(*´∇｀*) 欢迎回来！", st = setTimeout(function () {
            document.title = OriginTitile
        }, 3e3))
    })
</script>

<!-- 在线聊天工具  -->



<!-- 背景 canvas-nest -->



    <script src="/libs/instantpage/instantpage.js" type="module"></script>


</body>
</html>